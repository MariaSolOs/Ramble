#!/usr/bin/env node

require('dotenv').config({ path: '../.env' });
require('../config/mongoose');

//Models
const User = require('../models/user'),
      Experience = require('../models/experience'),
      Occurrence = require('../models/occurrence'),
      Creator = require('../models/creator'),
      Notification = require('../models/notification');

const creatorExpReminders = async () => {
    console.log('JOB START: CREATOR EXPERIENCE REMINDERS');
    try {
        //Delete old reminders
        await Notification.deleteMany({category: 'Creator-ExperienceReminder'});

        //Get experiences happening in the next 2 days
        const occs = await Occurrence.find({
            dateStart: new Date(new Date().setUTCHours(0, 0, 0)), 
            dateEnd: new Date(new Date(new Date().setDate(new Date().getDate() + 1)).setUTCHours(23, 59, 59))
        }, 'dateStart timeslot').populate({
            path: 'experience',
            select: 'title',
            populate: {
                path: 'creator',
                select: 'user'
            }
        });

        //Update notifications
        for(const occ of occs) {
            const when = occ.dateStart.getDate() === new Date().getDate()? 
                        'today' : 'tomorrow';
            const notif = new Notification({
                message: `Your experience "${occ.experience.title}" is happening ${
                when} at ${occ.timeslot.split('-')[0]}. Don't forget!`,
                user: occ.experience.creator.user,
                category: 'Creator-ExperienceReminder'
            });
            await notif.save();
        }

        console.log('JOB SUCCESS: CREATOR EXPERIENCE REMINDERS');
    } catch(err) {
        console.log(`JOB FAILED: CREATOR EXPERIENCE REMINDERS - ${err}`);
    }
    process.exit();
}
creatorExpReminders();
