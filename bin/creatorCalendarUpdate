#!/usr/bin/env node

require('dotenv').config({ path: '../.env' });
require('../config/mongoose');

const nodemailer = require('nodemailer'),
      fs = require('fs'),
      path = require('path'),
      {compile} = require('handlebars');

const Experience = require('../models/experience'),
      Creator = require('../models/creator'),
      User = require('../models/user');

//TODO: Add this job
const creatorCalendarUpdate = async () => {
    console.log('JOB STARTS: CALENDAR UPDATE REMINDERS');
    try {
        //Find all experiences where the availability is about to expire
        const in3Days = new Date();
        in3Days.setDate(new Date().getDate() + 3);
        const exps = await Experience.find({
                           'avail.to': {$lte: in3Days},
                           status: 'approved'
                    }, 'title creator avail images location')
                    .populate({
                        path: 'creator', 
                        select: 'user',
                        populate: {
                            path: 'user',
                            select: 'email'
                        }}
                    );

        const transporter = nodemailer.createTransport({
            host: 'smtp.zoho.com',
            port: 465,
            secure: true, 
            auth: {
                user: process.env.ZOHO_EMAIL, 
                pass: process.env.ZOHO_PASSWORD
            }
        });

        const source = fs.readFileSync(path.resolve(__dirname, 
                       '../emailTemplates/creatorCalendarUpdate.html'), 'utf-8').toString();              
        const template = compile(source);

        for(const exp of exps) {
            try {
                const htmlToSend = template({
                    expTitle: exp.title,
                    expImage: exp.images[0],
                    expLocation: exp.location.displayLocation,
                    calendarUrl: `${process.env.CLIENT_URL}/api/email/cal-update/${
                    exp._id}/${exp.creator.user._id}`
                });
                await transporter.sendMail({
                    from: {
                        name: 'ramble',
                        address: process.env.ZOHO_EMAIL
                    }, 
                    to: exp.creator.user.email.address,
                    subject: 'Time to update your calendar!', 
                    text: `Your availabilities for "${exp.title}" need to be updated. ` + 
                          'Go to your Creator dashboard and list your availabilities' + 
                          ' for the next period.', 
                    html: htmlToSend
                });
            } catch(err) { 
                console.log(`ERROR SENDING EMAIL: ${err}`);
                continue; 
            }
        }

        console.log('JOB SUCCESS: CALENDAR UPDATE REMINDERS');
    } catch(err) {
        console.log(`JOB FAILED: CALENDAR UPDATE REMINDERS - ${err}`);
    }
    process.exit();
}

creatorCalendarUpdate();